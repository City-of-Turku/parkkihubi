{% extends "admin/login.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'helusers/css/helusers.css' %}"/>
{% if password_login_disabled %}
<link rel="stylesheet" href="{% static 'helusers/css/password_login_disabled.css' %}"/>
{% endif %}
{% endblock %}

{% block content %}
{% if helsinki_provider_installed %}
<div id="helsinki-login"{% if grappelli_installed %} class="helusers-hide"{% endif %}>
    <p>Kirjaudu sisään Turun kaupungin työntekijän tunnuksella:</p>
    <div id="top-bottom-margins">
        {# Use helsinki_login_url if it's valid (not empty, not /admin/login, and not /login/) #}
        {# Otherwise use fallback to construct Tunnistamo OAuth URL #}
        {% if helsinki_login_url and helsinki_login_url != '' and helsinki_login_url != '/admin/login' and helsinki_login_url != '/login/' and '/admin/login' not in helsinki_login_url and helsinki_login_url|slice:":7" != '/login/' %}
            {# helusers provided a valid login URL #}
            <a href="{{ helsinki_login_url }}{% if redirect_path %}?next={{ redirect_path|urlencode }}{% endif %}">
        {% else %}
            {# Fallback: use social_django URL pattern directly #}
            {# social_django URLs are at /login/<provider>/ #}
            {# The provider name for Tunnistamo with helusers is typically 'tunnistamo' #}
            <a href="/login/tunnistamo/{% if redirect_path %}?next={{ redirect_path|urlencode }}{% endif %}">
        {% endif %}
            <button id="helsinki-login-btn" class="button grp-button grp-default" type="button">Turku Login</button>
        </a>
    </div>
{% if not password_login_disabled %}
    <p>
        Jos sinulla on erilliset ylläpitotunnukset, kirjaudu sisään käyttäjätunnuksella
        ja salasanalla.
    </p>
{% endif %}
</div>
{% endif %}

{{ block.super }}

{% if request.user and request.user.is_authenticated and helsinki_logout_url %}
<form id="logout-form" method="post" action="{{ helsinki_logout_url }}">
    {% csrf_token %}
    <div class="submit-row">
        <input type="submit" value="{% translate "Log out" %}">
    </div>
</form>
{% endif %}

{% if grappelli_installed %}
<script type="text/javascript">
(function() {
    var $ = grp.jQuery;

    $el = $("#helsinki-login");
    $el.addClass('form-row grp-row');
    $el.prependTo($('div.module')).show();
})();
</script>
{% endif %}

{% endblock %}

