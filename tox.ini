[tox]
envlist = py310,requirements,style
skipsdist = True

[testenv]
# Use system site packages to access python3-lxml installed via apt in Docker
# This avoids needing to build lxml from source (requires libxml2/libxslt dev packages)
# If running locally without system lxml, you may need to install libxml2-dev and libxslt-dev
sitepackages = True
deps =
    -rrequirements.txt
    -rrequirements-test.txt
passenv = CI
setenv =
    DEBUG=0
    SECRET_KEY=topsecret123
commands =
    pytest -ra -vvv --strict --doctest-modules --exitfirst {posargs:--cov=. --cov-report=term --cov-report=xml}

[testenv:requirements]
basepython = python3.10
deps =
    -rrequirements-pip.txt
commands_pre =
    # Create filtered requirements file without packages that require system libraries
    # These packages need to be built from source: lxml (libxml2/libxslt), pyproj (PROJ), psycopg2 (PostgreSQL)
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_system_libs.txt', 'w') as out: out.writelines([l for l in f if not (l.strip().startswith('lxml==') or l.strip().startswith('pyproj==') or l.strip().startswith('psycopg2==') or l.strip().startswith('owslib=='))])"
    # Install filtered requirements (without packages requiring system libraries)
    pip install -r /tmp/req_no_system_libs.txt
    # Install psycopg2-binary instead of psycopg2 (pre-built, no build dependencies)
    pip install psycopg2-binary==2.9.9
    # Upgrade chardet to satisfy tox 4.32.0 requirement (chardet>=5.2)
    # The project uses chardet==3.0.4, but tox needs a newer version
    pip install --upgrade "chardet>=5.2"
    # Install conditional dependencies to satisfy pip check false positives
    # These are only needed for older Python versions, but pip check doesn't understand that
    pip install importlib-metadata contextlib2 dataclasses backports-zoneinfo
commands = pip {posargs:check}

[testenv:style]
basepython = python3.10
deps = -rrequirements-style.txt
commands = flake8 {posargs:--enable=T}

[testenv:sanitizer]
basepython = python3.10
deps = -rrequirements.txt
commands = {envpython} manage.py check_sanitizerconfig

[gh-actions]
python =
    3.10: py310
problem_matcher = False
