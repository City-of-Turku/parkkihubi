[tox]
envlist = py310,requirements,style
skipsdist = True

[testenv]
# Install PyJWT first to resolve version conflict
# djangorestframework-jwt requires <2.0.0, but social-auth-core requires >=2.10.1
deps =
    PyJWT[crypto]==2.10.1
passenv = CI
setenv =
    DEBUG=0
    SECRET_KEY=topsecret123
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt and drf-jwt-2fa
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l) and '==' in l)])"
    # Install requirements without djangorestframework-jwt and drf-jwt-2fa
    pip install -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
    # Install test requirements
    pip install -r requirements-test.txt
commands =
    pytest -ra -vvv --strict --doctest-modules \
    --exitfirst \  # DEBUGGING ONLY
    {posargs:--cov=. --cov-report=term --cov-report=xml}

[testenv:requirements]
basepython = python3.10
deps =
    PyJWT[crypto]==2.10.1
    -rrequirements-pip.txt
# Override commands_pre to handle PyJWT conflict for pip check
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt and drf-jwt-2fa
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l) and '==' in l)])"
    # Install requirements without djangorestframework-jwt and drf-jwt-2fa
    pip install -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
commands = pip {posargs:check}

[testenv:style]
basepython = python3.10
deps = -rrequirements-style.txt
commands = flake8 {posargs:--enable=T}

[testenv:sanitizer]
basepython = python3.10
deps = -rrequirements.txt
commands = {base_python} manage.py check_sanitizerconfig

[gh-actions]
python =
    3.10: py310
problem_matcher = False
