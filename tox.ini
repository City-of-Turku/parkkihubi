[tox]
envlist = py310,requirements,style
skipsdist = True

[testenv]
# Install PyJWT first to resolve version conflict
# djangorestframework-jwt requires <2.0.0, but social-auth-core requires >=2.10.1
deps =
    PyJWT[crypto]==2.10.1
passenv = CI
setenv =
    DEBUG=0
    SECRET_KEY=topsecret123
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt, drf-jwt-2fa, and psycopg2
    # psycopg2 requires build dependencies, so we'll use psycopg2-binary instead for testing
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l or l.strip().startswith('psycopg2==')) and '==' in l)])"
    # Install psycopg2-binary instead of psycopg2 (pre-built binary, no build dependencies needed)
    pip install psycopg2-binary==2.9.9
    # Install requirements without djangorestframework-jwt, drf-jwt-2fa, and psycopg2
    pip install -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
    # Install test requirements
    pip install -r requirements-test.txt
commands =
    pytest -ra -vvv --strict --doctest-modules --exitfirst {posargs:--cov=. --cov-report=term --cov-report=xml}

[testenv:requirements]
basepython = python3.10
deps =
    PyJWT[crypto]==2.10.1
    -rrequirements-pip.txt
# Override commands_pre to handle PyJWT conflict for pip check
# Filter out packages that require system libraries (lxml) or are not needed for Python 3.10 (backports.zoneinfo)
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt, drf-jwt-2fa, and lxml
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l or l.strip().startswith('lxml==')) and '==' in l)])"
    # Install requirements without djangorestframework-jwt, drf-jwt-2fa, and lxml
    # Note: backports.zoneinfo will fail to build from source on Python 3.10, but it's not needed
    # Python 3.10 has zoneinfo built-in. Django's conditional dependency shouldn't apply on Python 3.10,
    # but pip still tries to resolve it. This is a known issue with pip's handling of conditional dependencies.
    # We'll install what we can - pip check will still verify compatibility of installed packages.
    python -c "import subprocess, sys; result = subprocess.run([sys.executable, '-m', 'pip', 'install', '-r', '/tmp/req_no_jwt.txt'], check=False, capture_output=True); output = (result.stdout or b'').decode() + (result.stderr or b'').decode(); sys.exit(0 if result.returncode == 0 or ('backports.zoneinfo' in output and 'Failed building wheel' in output) else result.returncode)"
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
commands = pip {posargs:check}

[testenv:style]
basepython = python3.10
# Filter out lxml from style requirements (not needed for flake8, requires system libraries)
commands_pre =
    python -c "with open('requirements-style.txt') as f, open('/tmp/req_style_no_lxml.txt', 'w') as out: out.writelines([l for l in f if not l.strip().startswith('lxml==')])"
    pip install -r /tmp/req_style_no_lxml.txt
commands = flake8 {posargs:--enable=T}

[testenv:sanitizer]
basepython = python3.10
# Install PyJWT first to resolve version conflict
# djangorestframework-jwt requires <2.0.0, but social-auth-core requires >=2.10.1
deps =
    PyJWT[crypto]==2.10.1
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt and drf-jwt-2fa
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l) and '==' in l)])"
    # Install requirements without djangorestframework-jwt and drf-jwt-2fa
    pip install -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
commands = {envpython} manage.py check_sanitizerconfig

[gh-actions]
python =
    3.10: py310
problem_matcher = False
