[tox]
envlist = py310,requirements,style
skipsdist = True

[testenv]
# Install PyJWT first to resolve version conflict
# djangorestframework-jwt requires <2.0.0, but social-auth-core requires >=2.10.1
deps =
    PyJWT[crypto]==2.10.1
passenv = CI
setenv =
    DEBUG=0
    SECRET_KEY=topsecret123
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt and drf-jwt-2fa
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l) and '==' in l)])"
    # Install requirements without djangorestframework-jwt and drf-jwt-2fa
    pip install -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
    # Install test requirements
    pip install -r requirements-test.txt
commands =
    pytest -ra -vvv --strict --doctest-modules \
    --exitfirst \  # DEBUGGING ONLY
    {posargs:--cov=. --cov-report=term --cov-report=xml}

[testenv:requirements]
basepython = python3.10
deps =
    PyJWT[crypto]==2.10.1
    -rrequirements-pip.txt
# Override commands_pre to handle PyJWT conflict for pip check
# Filter out packages that require system libraries (lxml) or are not needed for Python 3.10 (backports.zoneinfo)
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt, drf-jwt-2fa, and lxml
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l or l.strip().startswith('lxml==')) and '==' in l)])"
    # Install a dummy backports.zoneinfo package to satisfy Django's conditional dependency
    # Django requires backports.zoneinfo for Python < 3.9, but pip may still check it on Python 3.10
    # This dummy package uses Python 3.10's built-in zoneinfo module
    python -c "import os, tempfile, subprocess, sys; d=tempfile.mkdtemp(); os.chdir(d); os.makedirs('backports/zoneinfo', exist_ok=True); open('backports/__init__.py', 'w').close(); open('backports/zoneinfo/__init__.py', 'w').write('from zoneinfo import *\nfrom zoneinfo import ZoneInfo\n__all__ = [\"ZoneInfo\"]\n'); open('setup.py', 'w').write('from setuptools import setup\nsetup(name=\"backports.zoneinfo\", version=\"0.2.1\", packages=[\"backports\", \"backports.zoneinfo\"])\n'); subprocess.run([sys.executable, '-m', 'pip', 'install', '--no-deps', '.'], check=False)"
    # Install requirements without djangorestframework-jwt, drf-jwt-2fa, and lxml
    pip install -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
commands = pip {posargs:check}

[testenv:style]
basepython = python3.10
deps = -rrequirements-style.txt
commands = flake8 {posargs:--enable=T}

[testenv:sanitizer]
basepython = python3.10
# Install PyJWT first to resolve version conflict
# djangorestframework-jwt requires <2.0.0, but social-auth-core requires >=2.10.1
deps =
    PyJWT[crypto]==2.10.1
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt and drf-jwt-2fa
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l) and '==' in l)])"
    # Install requirements without djangorestframework-jwt and drf-jwt-2fa
    pip install -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
commands = {base_python} manage.py check_sanitizerconfig

[gh-actions]
python =
    3.10: py310
problem_matcher = False
