[tox]
envlist = py310,requirements,style
skipsdist = True

[testenv]
# Install PyJWT first to resolve version conflict
# djangorestframework-jwt requires <2.0.0, but social-auth-core requires >=2.10.1
deps =
    PyJWT[crypto]==2.10.1
passenv = CI
setenv =
    DEBUG=0
    SECRET_KEY=topsecret123
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt and drf-jwt-2fa
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l) and '==' in l)])"
    # Install requirements without djangorestframework-jwt and drf-jwt-2fa
    pip install -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
    # Install test requirements
    pip install -r requirements-test.txt
commands =
    pytest -ra -vvv --strict --doctest-modules \
    --exitfirst \  # DEBUGGING ONLY
    {posargs:--cov=. --cov-report=term --cov-report=xml}

[testenv:requirements]
basepython = python3.10
deps =
    PyJWT[crypto]==2.10.1
    -rrequirements-pip.txt
# Override commands_pre to handle PyJWT conflict for pip check
# Filter out packages that require system libraries (lxml) or are not needed for Python 3.10 (backports.zoneinfo)
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt, drf-jwt-2fa, and lxml
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l or l.strip().startswith('lxml==')) and '==' in l)])"
    # Create and install a dummy backports.zoneinfo package that uses Python 3.10's built-in zoneinfo
    # This satisfies the dependency without building from source
    # Use version 0.2.1 to match common requirements
    python -c "import os, tempfile, subprocess, sys; d=tempfile.mkdtemp(); os.chdir(d); os.makedirs('backports/zoneinfo', exist_ok=True); open('backports/__init__.py', 'w').close(); open('backports/zoneinfo/__init__.py', 'w').write('try:\n    from zoneinfo import *\n    from zoneinfo import ZoneInfo\n    __all__ = [\"ZoneInfo\"]\nexcept ImportError:\n    pass\n'); open('setup.py', 'w').write('from setuptools import setup\nsetup(name=\"backports.zoneinfo\", version=\"0.2.1\", py_modules=[], packages=[\"backports\", \"backports.zoneinfo\"])\n'); result = subprocess.run([sys.executable, '-m', 'pip', 'install', '--no-deps', '--force-reinstall', '.'], capture_output=True, check=False); sys.exit(0)"
    # Install requirements without djangorestframework-jwt, drf-jwt-2fa, and lxml
    # Use --only-binary=backports.zoneinfo to prevent building from source
    # The dummy backports.zoneinfo installed above should satisfy the dependency
    # If no wheel is available, pip will skip it (Python 3.10 has zoneinfo built-in)
    pip install --only-binary=backports.zoneinfo -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
commands = pip {posargs:check}

[testenv:style]
basepython = python3.10
deps = -rrequirements-style.txt
commands = flake8 {posargs:--enable=T}

[testenv:sanitizer]
basepython = python3.10
# Install PyJWT first to resolve version conflict
# djangorestframework-jwt requires <2.0.0, but social-auth-core requires >=2.10.1
deps =
    PyJWT[crypto]==2.10.1
commands_pre =
    # Create filtered requirements file without djangorestframework-jwt and drf-jwt-2fa
    python -c "with open('requirements.txt') as f, open('/tmp/req_no_jwt.txt', 'w') as out: out.writelines([l for l in f if not (('djangorestframework-jwt' in l or 'drf-jwt-2fa' in l) and '==' in l)])"
    # Install requirements without djangorestframework-jwt and drf-jwt-2fa
    pip install -r /tmp/req_no_jwt.txt
    # Install djangorestframework-jwt without dependency checks (using already installed PyJWT 2.10.1)
    pip install --no-deps djangorestframework-jwt==1.11.0
    # Install drf-jwt-2fa without dependency checks (djangorestframework-jwt is already installed)
    pip install --no-deps drf-jwt-2fa==0.3.0
commands = {base_python} manage.py check_sanitizerconfig

[gh-actions]
python =
    3.10: py310
problem_matcher = False
