#!/bin/sh

set -e

docs="
api/enforcement
api/operator
api/public
api/data
"

docs_dir=$(cd "$(dirname "$0")" && pwd)/docs
generator_dir=$docs_dir/doc-generator
openapi=$generator_dir/node_modules/.bin/openapi

default_output_dir=$docs_dir/generated

if [ "$1" = "-h" -o "$1" = "--help" ]; then
    echo "Usage: $0 [OUTPUT_DIR]"
    echo "       $0 [-h|--help]"
    exit 0
fi

if [ -n "$1" ]; then
    output_dir=$1
else
    output_dir=$default_output_dir
fi

if [ ! -e "$openapi" ]; then
    echo "Installing @redocly/cli for the \"openapi\" tool"
    old_dir=$(pwd)
    cd "$generator_dir"
    NODE_ENV=production yarn
    cd "$old_dir"
    echo
fi

for name in $docs; do
    echo "Generating $name documentation"
    "$openapi" build-docs "$docs_dir/$name.yaml" -o "$output_dir/$name/index.html"

    # Add <base> tag to fix relative links when served from /docs/ path
    # Remove "api/" prefix from name (e.g., "api/enforcement" -> "enforcement")
    # Base path should be "/docs/enforcement/" not "/docs/api/enforcement/"
    base_name=$(echo "$name" | sed 's|^api/||')
    base_path="/docs/$base_name/"

    # Use sed to insert <base> tag right after <head> tag
    # This ensures all relative links resolve correctly
    if [ -f "$output_dir/$name/index.html" ]; then
        # macOS sed requires -i '' for in-place editing, Linux uses -i
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s|<head>|<head>\n  <base href=\"$base_path\">|" "$output_dir/$name/index.html"
        else
            sed -i "s|<head>|<head>\n  <base href=\"$base_path\">|" "$output_dir/$name/index.html"
        fi
        echo "  Added base tag: $base_path"
    fi
    echo
done

echo "Documentation generated to $output_dir"
